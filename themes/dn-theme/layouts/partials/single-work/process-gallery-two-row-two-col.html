<section class="process meta-section bg-accent">
    <div class="row wrapper "> 
        <div class="col-md-6 col-lg-5">
            <h1 class="text-pink">{{.subsection.Title}}</h1>
            <p>{{.subsection.Content}}</p>

            <!-- Group 1: images below description -->
            {{with .page.Resources.Match "process-image"}}
            {{range sort . "Params.order"}}
            {{if eq .Params.group 1}}
            <div class="row ">
                <div class="col-md-3 masonry-item">
                    <figure class="figure">
                        <img src="{{.Permalink}}"
                             alt="{{.Title}}"
                             class="figure-img img-fluid">
                        {{if .Params.caption }}
                        <figcaption class="figure-caption">{{.Title}}</figcaption>
                        {{end }}
                    </figure>
                </div>
            </div>
            {{end}}
            {{end}}
            {{end}}
        </div>

        <!-- Group 2: images to right of  description -->
        <div class="col-md-6 col-lg-7">
            <div class="masonry group-2 ">
                {{with .page.Resources.Match "process-image"}}
                {{ $group2 := where . "Params.group" 2 }}
                {{$colsa := div (len $group2) 2.0 }}
                {{$colsb := math.Ceil $colsa}}
                {{$colsmd := div 12 $colsb}}
                {{range sort $group2 "Params.order"}}
                <div class="masonry-item ">
                    <figure class="figure masonry-content">
                        <img src="{{.Permalink}}"
                             alt="{{.Title}}"
                             class="figure-img img-fluid">
                        {{if .Params.caption }}
                        <figcaption class="figure-caption">{{.Title}}</figcaption>
                        {{end }}
                    </figure>
                </div>
                {{end}}
                {{end}}
            </div>
        </div>
    </div>
    
    <!-- Group 3: images in new row -->
    <div class="row wrapper masonry group-3 py-4">
        {{with .page.Resources.Match "process-image"}}
        {{ $group3 := where . "Params.group" 3 }}
        {{$colsa := div (len $group3) 2.0 }}
        {{$colsb := math.Ceil $colsa}}
        {{$colsmd := div 12 $colsb}}
        {{$colslg := div 12 (len $group3)}}
        {{range sort $group3 "Params.order"}}
        <div class="masonry-item">
                <figure class="figure masonry-content">
                    <img src="{{.Permalink}}"
                            alt="{{.Title}}"
                            class="figure-img img-fluid">
                    {{if .Params.caption }}
                    <figcaption class="figure-caption">{{.Title}}</figcaption>
                    {{end }}
                </figure>
            </div>
            {{end}}
            {{end}}
    </div>
</section>

<script>
        /**
         * Set appropriate spanning to any masonry item
         *
         * Get different properties we already set for the masonry, calculate 
         * height or spanning for any cell of the masonry masonry based on its 
         * content-wrapper's height, the (row) gap of the grid, and the size 
         * of the implicit row tracks.
         *
         * @param item Object A brick/tile/cell inside the masonry
         * @link https://w3bits.com/css-grid-masonry/
         */
            function resizeMasonryItem(item) {
                /* Get the masonry object, its row-gap, and the size of its implicit rows */
                var grid = document.getElementsByClassName('masonry')[0];
                if (grid) {
                    var rowGap = parseInt(window.getComputedStyle(grid).getPropertyValue('grid-row-gap')),
                        rowHeight = parseInt(window.getComputedStyle(grid).getPropertyValue('grid-auto-rows')),
                        gridImagesAsContent = item.querySelector('img.masonry-content');

                    /*
                     * Spanning for any brick = S
                     * Grid's row-gap = G
                     * Size of grid's implicitly create row-track = R
                     * Height of item content = H
                     * Net height of the item = H1 = H + G
                     * Net height of the implicit row-track = T = G + R
                     * S = H1 / T
                     */
                    var rowSpan = Math.ceil((item.querySelector('.masonry-content').getBoundingClientRect().height + rowGap) / (rowHeight + rowGap));

                    /* Set the spanning as calculated above (S) */
                    item.style.gridRowEnd = 'span ' + rowSpan;
                    if (gridImagesAsContent) {
                        item.querySelector('img.masonry-content').style.height = item.getBoundingClientRect().height + "px";
                    }
                }
            }

            /**
            * Apply spanning to all the masonry items
            *
            * Loop through all the items and apply the spanning to them using
            * `resizeMasonryItem()` function.
            *
            * @uses resizeMasonryItem
            * @link https://w3bits.com/css-grid-masonry/
            */
            function resizeAllMasonryItems() {
                // Get all item class objects in one list
                var allItems = document.querySelectorAll('.masonry-item');

                /*
                 * Loop through the above list and execute the spanning function to
                 * each list-item (i.e. each masonry item)
                 */
                if (allItems) {
                    for (var i = 0; i > allItems.length; i++) {
                        resizeMasonryItem(allItems[i]);
                    }
                }
            }

            /**
            * Resize the items when all the images inside the masonry masonry
            * finish loading. This will ensure that all the content inside our
            * masonry items is visible.
            *
            * @uses ImagesLoaded
            * @uses resizeMasonryItem
            * @link https://w3bits.com/css-grid-masonry/
            */
            function waitForImages() {
                //var masonry = document.getElementById("masonry");
                var allItems = document.querySelectorAll('.masonry-item');
                if (allItems) {
                    for (var i = 0; i < allItems.length; i++) {
                        imagesLoaded(allItems[i], function (instance) {
                            var item = instance.elements[0];
                            resizeMasonryItem(item);
                            console.log("Waiting for Images");
                        });
                    }
                }
            }

            /* Resize all the masonry items on the load and resize events */
            var masonryEvents = ['load', 'resize'];
            masonryEvents.forEach(function (event) {
                window.addEventListener(event, resizeAllMasonryItems);
            });

            /* Do a resize once more when all the images finish loading */
            waitForImages();

</script>